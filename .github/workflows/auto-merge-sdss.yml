name: Auto-merge SDSS Organization PRs

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Check if author is SDSS organization member
        id: check_member
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Check if the PR author is a member of the sdss organization
          status=$(gh api orgs/sdss/members/$PR_AUTHOR --silent -i 2>/dev/null | head -1 | awk '{print $2}')
          if [ "$status" = "204" ]; then
            echo "is_member=true" >> $GITHUB_OUTPUT
            echo "‚úÖ $PR_AUTHOR is a member of the sdss organization"
          else
            echo "is_member=false" >> $GITHUB_OUTPUT
            echo "‚ùå $PR_AUTHOR is not a member of the sdss organization"
          fi

      - name: Auto-merge PR
        if: steps.check_member.outputs.is_member == 'true' && github.event.pull_request.draft == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Auto-merging PR #$PR_NUMBER from sdss organization member"
          gh pr merge $PR_NUMBER --repo $REPO --auto --squash

      - name: Add comment
        if: steps.check_member.outputs.is_member == 'true' && github.event.pull_request.draft == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          gh pr comment $PR_NUMBER --repo $REPO --body "ü§ñ Auto-merge enabled for SDSS organization member. PR will merge automatically when all checks pass."
